Most of this code is copied from Robert Smallshire's excellent talk: https:/www.youtube.com/watch?v=c5wodlqGK-M
